<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive de Kribi</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        #map {
            height: 600px;
        }
        #info {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<h2>Carte Interactive de Kribi</h2>
<div id="map"></div>
<div id="info"></div>

<script>
    // Initialisation de la carte centrée sur Kribi
    var map = L.map('map').setView([2.9397, 9.9106], 13); // Coordonnées de Kribi

    // Ajout d'une couche OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '© OpenStreetMap'
    }).addTo(map);

    // Outils de dessin
    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    var drawControl = new L.Control.Draw({
        edit: {
            featureGroup: drawnItems
        },
        draw: {
            polygon: true,
            polyline: true,
            marker: true,
            circle: false,
            rectangle: false,
            circlemarker: false
        }
    });
    map.addControl(drawControl);

    // Fonction pour calculer la distance entre les points d'une polyline
    function calculateDistance(layer) {
        var latlngs = layer.getLatLngs();
        var distance = 0;
        for (var i = 0; i < latlngs.length - 1; i++) {
            distance += latlngs[i].distanceTo(latlngs[i + 1]);
        }
        return (distance / 1000).toFixed(2); // Convertir en km
    }

    // Fonction pour calculer le périmètre et la surface d'un polygone
    function calculatePolygonStats(layer) {
        var latlngs = layer.getLatLngs()[0];
        var perimeter = 0;
        var area = L.GeometryUtil.geodesicArea(latlngs);

        for (var i = 0; i < latlngs.length - 1; i++) {
            perimeter += latlngs[i].distanceTo(latlngs[i + 1]);
        }
        perimeter += latlngs[latlngs.length - 1].distanceTo(latlngs[0]); // Fermeture du polygone

        return {
            perimeter: (perimeter / 1000).toFixed(2), // Convertir en km
            area: (area / 1000000).toFixed(2) // Convertir en km²
        };
    }

    // Fonction pour afficher les informations sur la carte
    function updateInfo(layer) {
        var type = layer instanceof L.Marker ? 'marker' :
                   layer instanceof L.Polyline && !(layer instanceof L.Polygon) ? 'polyline' : 'polygon';

        if (type === 'marker') {
            var coords = layer.getLatLng();
            document.getElementById('info').innerHTML = `Point placé aux coordonnées : ${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)}`;
        }

        if (type === 'polyline') {
            var distance = calculateDistance(layer);
            document.getElementById('info').innerHTML = `Ligne tracée, distance totale : ${distance} km`;
        }

        if (type === 'polygon') {
            var stats = calculatePolygonStats(layer);
            document.getElementById('info').innerHTML = `Polygone tracé, périmètre : ${stats.perimeter} km, surface : ${stats.area} km²`;
        }
    }

    // Gestion des événements de création
    map.on(L.Draw.Event.CREATED, function (event) {
        var layer = event.layer;
        drawnItems.addLayer(layer);
        updateInfo(layer);
    });

    // Gestion des événements de modification
    map.on(L.Draw.Event.EDITED, function (event) {
        var layers = event.layers;
        layers.eachLayer(function (layer) {
            updateInfo(layer);
        });
    });

    // Charger et appliquer le fichier GeoJSON
    fetch('/home/cedric/Code/IDS/idsproject/authentification/templates/authentification/concessions_PAK.geojson') // Charger le fichier GeoJSON
        .then(response => response.json())
        .then(data => {
            // Ajouter le GeoJSON sur la carte
            L.geoJSON(data, {
                onEachFeature: function (feature, layer) {
                    // Afficher les informations des propriétés si disponibles
                    if (feature.properties) {
                        alert(feature.properties)
                        layer.bindPopup(`Propriété : ${JSON.stringify(feature.properties)}`);
                    }
                }
            }).addTo(map);
        })
        .catch(err => console.error(err));

</script>

</body>
</html>
